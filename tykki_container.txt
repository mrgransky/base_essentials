Pipeline Steps:

Phase 1: Disable Old Conda Setups in Your User Environment
$ cd
$ vim ~/.bashrc
Comment out or delete the line:

# export PATH="/projappl/project_2004072/CondaCSC/bin:$PATH"

Save and exit: Esc => :wq!

Apply ~/.bashrc Changes and Verify:

The most reliable way is to log out of Puhti and log back in.

Alternatively, for the current session (less complete than a fresh login): source ~/.bashrc

Verify:

$ echo $PATH
$ which python

Phase 2: Delete the Old CondaCSC Directory Content

$ module purge
$ module load tykky
$ cd /projappl/project_2004072/

Recreate the Empty Directory for the New Installation:
We need an empty directory for Tykky to install into.

$ rm -rfv CondaCSC packages.sh
$ mkdir -v CondaCSC && ls -l

Phase 3: Create the New Tykky Environment (Named CondaCSC)

This phase uses Tykky to build a fresh, clean environment.

Prepare environment.yml and requirements.txt:

Create environment.yml (e.g., in your home directory or /projappl/project_2004072/) with your desired Conda packages.

$ vim environment.yml

name: CondaCSC_env
channels:
  - conda-forge
dependencies:
  - python=3.12

Create requirements.txt (in the same location) for pip packages.

$ conda-containerize new --prefix CondaCSC environment.yml

# Phase 4: Set Up PATH for the New CondaCSC Environment

$ cd
$ vim ~/.bashrc

# At the end of ~/.bashrc
export PATH="/projappl/project_2004072/CondaCSC/bin:$PATH"

Save and exit: Esc => :wq!
Log out of Puhti or Mahti (cttl + d) and log back in (most reliable).

Or source ~/.bashrc.

Verify:

$ echo $PATH
$ which pip

which python and pip should now point to locations inside /projappl/project_2004072/CondaCSC/bin/.
$ cd /projappl/project_2004072/

Test the New Environment:
$ which python
$ python -V

continue with package installation:
$ module purge
$ module load tykky
$ cd /projappl/project_2004072

# remove old packages.sh
$ rm -rfv packages.sh

$ vim packages.sh
# modify/add to packages.sh file: <<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>

echo "Checking PATH and python/pip/conda"
echo "PATH: $PATH"
echo -n "python -> "; which python
echo -n "pip -> "; which pip
echo -n "conda -> "; which conda
conda list --show-channel-urls

pip cache info
pip cache purge

# Install the C++ toolchain INSIDE the Conda environment ---
# This places a modern libstdc++.so.6 directly into the Conda environment's
# `lib` directory. This solves the `GLIBCXX_3.4.32 not found` error at RUNTIME,
# making the environment portable and removing the need for `module load gcc`
# just to run a python script.
echo "--- Installing Conda C++ toolchain (gxx) for runtime compatibility ---"
conda install -c conda-forge --yes gxx_linux-64
echo "---------------------------------------------------------------------"

echo "Loading latest CUDA module for cluster: $SLURM_CLUSTER_NAME"
if [ "$SLURM_CLUSTER_NAME" = "mahti" ]; then
  module load gcc/10.4
else
  module load gcc/13.2
fi

module load cuda/12.6

nvcc --version
which nvcc

echo "Upgrading pip and setuptools"
pip install --upgrade pip setuptools wheel

echo "Installing torch..."
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu126
pip install psutil packaging ninja

# install flash-attn ALONE. If this fails, we want to know immediately.
# --no-build-isolation to force it to use the recently installed PyTorch.
echo "--- Compiling Flash Attention ---"
# MEMORY LIMITATION
# We limit the build to 1 job at a time to prevent "killed" (OOM) errors.
export MAX_JOBS=1
pip install flash-attn --no-build-isolation

pip install fasttext --no-binary :all:
pip install mediapipe lingua-language-detector

echo "Installing other packages..."
pip install transformers bitsandbytes accelerate umap-learn hdbscan kneed sentence-transformers keybert 
pip install PyDrive2 google-api-python-client optree ftfy tabulate netCDF4 h5netcdf
pip install python-swiftclient rasterio geopandas pipdeptree 
pip install ipywidgets nbclassic jupyterlab
pip install scikit-learn rake-nltk fuzzywuzzy rapidfuzz plotly gensim pyarrow scipy stanza nltk joblib pydantic pycocotools
pip install numba dill matplotlib seaborn requests selenium beautifulsoup4 lxml html5lib pyenchant pyspelling langdetect libvoikko
pip install wordcloud tenacity natsort scikit-image scikit-multilearn openpyxl csvkit certifi sentencepiece

echo "Checking installed packages"
conda list --show-channel-urls
pipdeptree --reverse --packages torch
pipdeptree --reverse --packages blis
pipdeptree --reverse --packages transformers

$ cat packages.sh
$ conda-containerize update CondaCSC --post-install packages.sh